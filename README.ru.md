[вернуться в основной Readme файл](https://github.com/gaifut/GMP-Warranty_ID_bot/blob/main/README.md).

## Оглавление:
- [Для чего нужен этот бот.](#Для-чего-нужен-этот-бот)
- [Информация по использованию работающей версии бота.](#Информация-по-использованию-работающей-версии-бота)
- [Описание проекта.](#Описание-проекта)
- [Как скачать и запустить.](#Как-скачать-и-запустить)

## Для чего нужен этот бот.
Данный бот был сделан для быстрого отслеживания поставок заказчиками компании Гофромашины Премиум. В компании активно используются уникальные ID, по которым отдел поставок в том числе отслеживает статус заказа. Для сокращения времени ответа, а также для возможности отследить заказ 24/7 была добавлена возможность делать это автоматически при помощи бота. Бот заходит в таблицу, берет статус заказа, который соответствует ID и возвращает его в ответе. Информация о запросе фиксируется в Google Sheets, что позволяет отслеживать сколько было запросов, по каким заказам итп.

При схожих запросах бота легко адаптировать, при необходимости можно расширять его функционал.

## Информация по использованию работающей версии бота.
В данный момент бот запущен и любой может протестировать его в телеграме: @Gmach_helpdesk_bot. Также можно зайти [по QR-коду с сайта ООО Гофромашины Премиум ](http://g-mach.ru/servisy-dlya-klientov).
При заходе в бота есть меню, в котором 2 кнопки:
- /start (отвечает за запуск бота)
- /help (содержит краткое описание возможностей бота)

Любой может протестировать бота, следуя пошаговым инструкциям и нажимая на inline клавиатуру.
Для реализации запросов бот будет запрашивать ID поставок ЗЧ (запасных частей) либо ID рекламаций. Ниже несколько примеров ID, которые вернут разные статусы.
### Рабочие примеры ID рекламаций:
 - Em0042205002S2104
   Данный id не является ID рекламации, поэтому бот вернет сообщение об ошибке.
 - Qu079220223W0C
   Бот вернет статус: Ожидается ответ производителя по рекламации
 - Em003280922W1C
   Бот вернет статус: Груз доставлен заказчику 01.02.2023
Чтобы проверить несколько рекламаций можно после получения статуса о рекламации вводить следующий интересующий ID.
### Рабочие примеры ID поставок:
 - Em0042205002S2104
   Бот вернет статус: Груз предеан заказчику.
 - Em003280922W1C
   Данный id не является ID поставки, поэтому бот вернет сообщение об ошибке.
 - RO0772202302S2102
   Бот вернет статус: Груз на складе поставщика. Ожидание оплаты.
   
Для того, чтобы с ID рекламаций перейти в ID поставок необходимо перезапустить бота командой /start

## Описание проекта.
### Стек:
Python, Pandas, Gspread.
### Процесс работы программы.
При получении вводных данных от пользователя (id поставки или рекламации) бот делает следующее:
1. Заходит в соответствующую Excel таблицу на прописанную вкладку (зависит от того, что запросили) и находит в столбце статус значение, которое соответствует запрошенному id. Выглядит это примерно так:
   ![Screenshot from 2024-04-11 15-09-46](https://github.com/gaifut/GMP-Warranty_ID_bot/assets/113767276/636d4a85-a217-46cc-90a3-608edfc2deb9)
Это происходит "под капотом" при помощи библиотеки pandas.
2. Если бот нашел id, то он выводит его статус пользователю, если бот не нашел id, он выводит соответствующее сообщение.
3. Бот подключается к указанному Google Sheets при помощи API гугла (библиотека gspread) и фиксирует там:
   - id user'а, сделавшего запрос
   - ID поставки или рекламации, которое юзер ввел при запросе
   - время запроса (компьютерное, Гринвич, Москва)
   - номер запроса (считается для каждого пользователя в течение 1 сесссии).
   Выглядит это так:
   ![image](https://github.com/gaifut/GMP-Warranty_ID_bot/assets/113767276/f4000d2b-4894-4da6-9fb1-2050f47fc799)
### Примечания:
- Максимальное количество запросов за 1 сессию = 25, при превышении лимита бот попросит перезапустить его.

## Как скачать и запустить.
#### Важно! Проект делался на Windows, возможны проблемы при запуске на других операционных системах.
1. Fork'ните этот репозиторий.
2. Клонируйте форкнутый репозиторий.
3. Советую установить виртуальное окружение, например так: ```python -m venv venv```
   и далее активируйте его: ```. venv/Scripts/activate``` (для линукса это ```. venv/bin/activate```, но данный проект реализован на Windows)
   для деактивации можно набрать ```deactivate```
   Вероятно, Windows выдаст вам ошибку про Scripts, для ее устранения:
    - Зайдите в PowerShell как администратор (наберите powershell в пуск).
    - Наберите ```set-executionpolicy remotesigned```
    - Вас попросят подтвердить это, укажите Y или Yes.
    - После этого активащия виртуального окружения должна заработать.
5. Установите зависимости из requirements.txt
   ```pip install -r requirements. txt```
7. Создайте .env файл в папке, где находится проект, в него добавьте следующие переменные (ниже указан пример с вымышленными данными):
   ```
   API_KEY=123123123:SFDSsdsfgfOYSADBasdas123asdasdAGw
   bot_username=dummy_name_bot
   bot_name=dummy_name_bot
   Google_sheets_API_details=test-name-placeholder.json
   FEEDS=https://spreadsheets.google.com/feeds
   DRIVE=https://www.googleapis.com/auth/drive
   ```
   Если вы не хотите использовать какую-то функциональность, например Google API, то можно просто убрать код, отвечающий за это.

   #### Как зарегистрировать нового бота в Telegram:
   1. Зайдите в приложение телеграм и в поиске аккаунтов наберите @BotFather.
   2. Внизу кликните на меню и выберите Create a new bot либо просто наберите /newbot
   3. Напишите имя для вашего бота (может быть любым).
   4. Напишите имя пользователя для вашего бота, обязательно должно оканчиваться на bot, например: ui_bot, salesbot.
      После этого BotFather выдаст вам всю информацию о вашем боте, в том числе API токен (как в примере в пункте 7).
   #### Как установить API соединение с Google Sheets.
   1. Зайдите на ссылку https://console.cloud.google.com/projectcreate
   2. В Project name укажите имя вашего проекта и после нажмите кнопку CREATE.
   3. Включите google sheets API, для этого вверху страницы справа от лого GoogleCloud выберите имя вашего проекта. Далее в колонке слева выберите API, если его нет, внизу нажмите на MORE PRODUCTS, и далее зайдите в APIs & Services, перейдите в Enabled APIs & Services.
      На открывшейся странице вверху нажимите + ENABLE APIS AND SERVICES.
      Далее у вас откроется список APIs and Services, вы в нем ищете Google Sheets API и кликаете на него, после чего в открывшемся окне нажимаете ENABLE.
   4. Под APIs & Services в Google Sheets API выберите CREATE CREDENTIALS, в открывшемся окне выберите Google Sheets API и Application Data и нажмите NEXT.
      В открывшемся окне напишите Service account name (любое имя в одно слово) и нажмите CREATE AND CONTINUE.
      Выберите роль - Editor, нажмите CONTINUE и далее нажмите DONE.
   5. Теперь вам необходимо будет загрузить credentials, для этого перейдите в CREDENTIALS вкладку все в том же Google Sheets API, кликните на service account, что вы только что создали. В открывшемся окне нажмите на вкладку KEYS. В ней нажмите ADD KEY, create a new key. Key type   выберите JSON и нажмите CREATE. Файл загрузится на ваш компьютер, перенесите его в ту же папку, где находится ваш проект. Название файла укажите в переменной Google_sheets_API_details в вашем .env файле.
   6. Скопируйте email вашего service account (смотрите пункт 5), зайдите в Google Sheet, который вы планируете использовать для выгрузки данных (для этого в своем обычном гугл аккаунте можно создать новый sheet) и нажмите поделиться (share). В открывшемся окне вставьте скопированный адрес, убедитесь, что уровень доступа указан Editor и нажмите Send.
9. Создайте файл sensitive.py, в котором укажите адреса файлов с таблицами. Вы также можете не создавать отдельный файл, проект я делал давно и на Windows, поэтому оставил именно эту логику.
   Если хотите вносить минимум изменений, мой файл выглядел так:
   ```
   # sensitive.py
   # location paths
   excel_file_location_W = `указывается адрес таблицы для рекламаций`
   excel_file_location_S = `указывается адрес таблицы для обычных поставок`
   ```
10. Внесите изменения в файл definitions.py:

   Как минимум вам необходимо переопредилить названия файлов и вкладок (ниже строки 25 #GENERAL). В зависимости от целей проекта вы также можете изменить здесь название кнопок и прочие переменные.

11. Запустите проект из файла GMP_W_B_main 1.3.py (в VSCode горячая клавиша запуска F5). После этого ваш телеграм бот должен начать работать.
